---
title: "Untitled"
author: "Daniel Fireman (danielfireman@gmail.com)"
date: "April 14, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
require(dplyr)
require(ggpubr)
```

```{r}

# Extract
# cat *.out | grep PCP | cut -d' ' -f1 | cut -d: -f2
# cat *.out | grep PVN | cut -d' ' -f1 | cut -d: -f2

# 1 replica
# Run: cd inputgen/; go run main.go --duration=3600000 --r=10 --mu=0.0036 --bigOmega=0.003 --littleOmega=0.0001; cd ..; for i in `seq 1 10`; do go run main.go --rate=1 --warmup=0 --d=1h --i=inputgen/input_$i.csv > r1_$i.out; done
# Pack output: zip sim_1_out.zip r1_*.out

sim_1 <- data.frame("n"=1,
                    "pcp"=c(0.231876,0.097039,0.051976,0.093941,0.045551,0.152682,0.107873,0.135808,0.083458,0.079348,0.116016,0.069067,0.105772,0.201415,0.172598,0.131679,0.139450,0.083581,0.053739,0.201057,0.059495,0.191902,0.061721,0.133258,0.080955,0.085603,0.073845,0.142468,0.140606,0.109979),
                    "pvn"=c(0.231876,0.097039,0.051976,0.093941,0.045551,0.152682,0.107873,0.135808,0.083458,0.079348,0.116016,0.069067,0.105772,0.201415,0.172598,0.131679,0.139450,0.083581,0.053739,0.201057,0.059495,0.191902,0.061721,0.133258,0.080955,0.085603,0.073845,0.142468,0.140606,0.109979))

NROW(sim_1)

# 2 replicas
# Run: cd clustergo; for i in `seq 1 10`; do cd inputgen/; go run main.go --duration=3600000 --r=2 --mu=0.0036 --bigOmega=0.003 --littleOmega=0.0001; cd ..;  go run main.go --rate=1 --warmup=0 --d=1h --i=inputgen/input_1.csv,inputgen/input_2.csv > r2_$i.out; rm inputgen/input_*.csv; done
# Pack output: zip sim_2_out.zip r2_*.out; rm *.out

sim_2 <- data.frame("n"=2,
                    "pcp"=c(0.084379,0.130879,0.094645,0.088449,0.102019,0.112788,0.108854,0.094220,0.077600,0.174837,0.081916,0.076286,0.152145,0.169938,0.080344,0.092575,0.108636,0.071429,0.114786,0.107051,0.071500,0.163362,0.063602,0.076499,0.083898,0.121497,0.093398,0.114043,0.144002,0.121083),
                    "pvn"=c(0.002055,0.001449,0.011509,0.002199,0.010210,0.000000,0.007351,0.010867,0.000000,0.019363,0.002654,0.000000,0.006684,0.003646,0.002860,0.002351,0.002586,0.000000,0.003625,0.005784,0.002701,0.003498,0.003163,0.000277,0.000000,0.006762,0.001064,0.011734,0.000000,0.005259))

# 3 replicas
# Run: for i in `seq 1 10`; do cd inputgen/; go run main.go --duration=3600000 --r=3 --mu=0.0036 --bigOmega=0.003 --littleOmega=0.0001; cd ..;  go run main.go --rate=1 --warmup=0 --d=1h --i=inputgen/input_1.csv,inputgen/input_2.csv,inputgen/input_3.csv > r3_$i.out; rm inputgen/input_*.csv; done
# Pack output: zip sim_3_out.zip r3_*.out; rm *.out

sim_3 <- data.frame("n"=3,
                    "pcp"=c(0.078058,0.102355,0.108870,0.108252,0.136865,0.071004,0.113510,0.100964,0.093358,0.073519,0.076021,0.093621,0.130104,0.145861,0.149979,0.146823,0.112118,0.139088,0.107443,0.072921,0.081015,0.053835,0.124976,0.079671,0.128730,0.082217,0.115721,0.123018,0.118530,0.080040),
                    "pvn"=c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000))

# 4 Replicas
# Run: for i in `seq 1 10`; do cd inputgen/; go run main.go --duration=3600000 --r=4 --mu=0.0036 --bigOmega=0.003 --littleOmega=0.0001; cd ..;  go run main.go --rate=1 --warmup=0 --d=1h --i=inputgen/input_1.csv,inputgen/input_2.csv,inputgen/input_3.csv,inputgen/input_4.csv > r4_$i.out; rm inputgen/input_*.csv; done
# Pack output: zip sim_4_out.zip r4_*.out; rm *.out

sim_4 <- data.frame("n"=4,
                    "pcp"=c(0.092391,0.193141,0.119707,0.098379,0.114390,0.077782,0.097437,0.111713,0.126066,0.087241,0.106512,0.144235,0.090618,0.115772,0.112606,0.090728,0.082921,0.153324,0.100047,0.134142,0.130463,0.126058,0.094816,0.121627,0.093800,0.116010,0.093591,0.093362,0.088266,0.122434),
                    "pvn"=c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000))

# 5 Replicas
# Run: for i in `seq 1 10`; do cd inputgen/; go run main.go --duration=3600000 --r=5 --mu=0.0036 --bigOmega=0.003 --littleOmega=0.0001; cd ..;  go run main.go --rate=1 --warmup=0 --d=1h --i=inputgen/input_1.csv,inputgen/input_2.csv,inputgen/input_3.csv,inputgen/input_4.csv,inputgen/input_5.csv > r5_$i.out; rm inputgen/input_*.csv; done
# Pack output: zip sim_5_out.zip r5_*.out; rm *.out

sim_5 <- data.frame("n"=5,
                    "pcp"=c(0.142151,0.082239,0.124050,0.071008,0.135120,0.085755,0.083300,0.109171,0.084452,0.100819,0.068531,0.109139,0.091492,0.091701,0.107683,0.146709,0.125696,0.132023,0.130957,0.102996,0.117156,0.104614,0.117732,0.134748,0.129760,0.101332,0.065629,0.138111,0.105018,0.103950),
                    "pvn"=c(0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000))

analytical <- data.frame("n"=c(1,2,3,4,5),
                         "pvn"=c(0.097157, 0.010380, 0.001120, 0.000121, 0.000013),
                         "pcp"=c(0.097157, 0.106840, 0.107875, 0.107986, 0.107999),
                         "modelo"="Analítico")

# Calculates mean, sd, se and IC
# Inspired by: https://www.r-graph-gallery.com/4-barplot-with-error-bar.html
sim_raw_data <- cbind(rbind(sim_1, sim_2, sim_3, sim_4, sim_5),"modelo"="Simulado")
cmp_raw_data <- rbind(sim_raw_data, analytical)
cmp_data <- cmp_raw_data %>%
  group_by(n, modelo) %>%
  summarise( 
    count=n(),
    pvn_mean=mean(pvn),
    pvn_sd=sd(pvn),
    pcp_mean=mean(pcp),
    pcp_sd=sd(pcp)
  ) %>%
  mutate(pvn_se=pvn_sd/sqrt(count))  %>%
  mutate(pvn_ic=pvn_se * qt((1-0.05)/2 + .5, count-1)) %>%
  mutate(pcp_se=pcp_sd/sqrt(count))  %>%
  mutate(pcp_ic=pcp_se * qt((1-0.05)/2 + .5, count-1))

# Graphing results

ggplot(cmp_data, aes(x=n, y=pcp_mean, ymin=pcp_mean-pcp_ic, ymax=pcp_mean+pcp_ic)) +
  geom_bar(aes(fill = modelo), position = position_dodge(), stat="identity") +
  geom_errorbar(position=position_dodge(), width=.5) +
  ylim(0,.5) +
  scale_fill_brewer(palette="Dark2") +
  labs(
    x="Número de réplicas",
    y="PCP (%)",
    fill="Modelo") +
  theme_pubr() +
  theme(
    legend.position="bottom",
    panel.grid.major.x = element_line(colour = "darkgray", linetype = 3),
    panel.grid.minor.y = element_line(colour = "lightgray", linetype = 3, size=0.25),
    panel.grid.major.y = element_line(colour = "darkgray", linetype = 3))
ggsave("validation_pvn.png")

ggplot(cmp_data, aes(x=n, y=pvn_mean, ymin=pvn_mean-pvn_ic, ymax=pvn_mean+pvn_ic)) +
  geom_bar(aes(fill = modelo), position = position_dodge(), stat="identity") +
  geom_errorbar(position=position_dodge(), width=.5) +
  ylim(0,.5) +
  scale_fill_brewer(palette="Dark2") +
  labs(
    x="Número de réplicas",
    y="PCP (%)",
    fill="Modelo") +
  theme_pubr() +
  theme(
    legend.position="bottom",
    panel.grid.major.x = element_line(colour = "darkgray", linetype = 3),
    panel.grid.minor.y = element_line(colour = "lightgray", linetype = 3, size=0.25),
    panel.grid.major.y = element_line(colour = "darkgray", linetype = 3))
ggsave("validation_pvn.png")
```



